<!DOCTYPE html>
<html>

<head>
    <title>C50 Index</title>
    <style>
        .tr {text-align: right;}
        .tl {text-align: left;}
        .tc {text-align: center;}
        .dib {display: inline-block;}
        .w-100 {width: 100%;}
        .w-40 {width: 40%;}
        .w-30 {width: 30%;}
        .hover-bg-light-blue:hover {
          background-color: #b2b2b2;
        }
    </style>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src='./markact.js'></script>
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
</head>
<body>
    <script>
        // Parse CSV in ruby
        //  h = {}; (Dir.entries('all-coins') - ['.', '..']).map{|f| h[f.split('.')[0]] = CSV.read("all-coins/#{f}", headers: true).map(&:to_h)}
        let CoinsTable = function(data) {
            let Coins = coins => coins.map((coin,i) => {
                let coinInfo = coin['CoinInfo'];
                let conversionInfo = coin['ConversionInfo'];
                let raw = conversionInfo['RAW'][0].split('~');
                let price = raw[5];
                let supply = conversionInfo['Supply'];
                let marketCap = (price * supply).toLocaleString();
                let shortName = coinInfo['Name'].toLowerCase();;

                return (h('tr', {onclick: `drawChart('${shortName}')`, class: 'hover-bg-light-blue'},
                    h('td', {class: 'tc', scope: 'col'}, "" + (i + 1)),
                    h('td', {class: 'tl', scope: 'col'},
                    h('td', {class: 'dib', scope: 'col'},
                        h('img', {
                            class: 'img-responsive',
                            src: `https://www.cryptocompare.com${coinInfo['ImageUrl']}`,
                            width: '25px',
                            height: '25px'
                        }),
                        coinInfo['FullName'])
                        ),
                    h('td', {class: 'tr', scope: 'col'}, supply ? '$' + marketCap :  '_'),
                    h('td', {class: 'tr', scope: 'col'}, '$' + price),
                    h('td', {class: 'tr', scope: 'col'}, supply ? supply.toLocaleString() + ' ' + coinInfo['Name'] : '_'),
                ));
            });

            return (
                h('table', {class: 'table table-hover'},
                    h('th', {class: 'tc', scope: 'col'}, '#'),
                    h('th', {class: 'tl', scope: 'col'}, 'Name'),
                    h('th', {class: 'tr', scope: 'col'}, 'Market Cap'),
                    h('th', {class: 'tr', scope: 'col'}, 'Price'),
                    h('th', {class: 'tr', scope: 'col'}, 'Circulating Supply'),
                    Coins(data),
                    ));
        }


        function bootstrap() {
            let prev = "";
            let start = Date.now() / 1000 | 0;
            return (response) => {
                if(prev === response) return console.log('Equal skipping');
                let now = Date.now() / 1000 | 0 ;
                console.log('Updating after ' + (now - start) + ' seconds.');
                start = now;
                prev = response;
                response = JSON.parse(response);

                let children = (
                    render(h('div', {class: 'container tc'},
                        CoinsTable(response["Data"])))
                );
                let app = document.getElementById('coinsTable');
                if(app.firstChild) app.removeChild(app.firstChild);
                app.appendChild(children);
            }
        }


        function drawChart(comparedTo) {
          let startDate = moment().year(2016).startOf('year');
          let prevDate = startDate;

          function draw(data) {
            var scatterChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {scales: {xAxes: [{type: 'time',time: {unit: 'month'}}]}}
            });
          }

          let transformRow = (row, idx, divisor,xIndex=0, yIndex=1) => {
            if(idx == 0) return false;
            let date = new moment(row[xIndex]);
            // only one per month
            if(date.isAfter(prevDate, 'month') && date.unix() > startDate.unix()) {
              prevDate = date;

              let weightedMarketCap = (row[yIndex] || 0) / divisor;
              return {x: date, y: weightedMarketCap};
            } else {
              return false;
            }
          };

          let getDivisor = (rows, dateKey, priceKey) => {
            for(let i = 0; i < rows.length; i++) {
              if(rows[i][priceKey] > 0 && new moment(rows[i][dateKey]) >= startDate) {
                return rows[i][priceKey];
              }
            }
            return null;
          }

          var ctx = document.getElementById('chart').getContext('2d');
          readCSV('aggregated.csv').then((rows) => {
            let result = rows.map((row, i) => transformRow(row, i, rows[0][1],0, 1)).filter(a => a);
            return result;
          }).then((aggregatedRows) => {
            readCSV(`all-coins/${comparedTo}.csv`, {headers: true}).then((rows) => {
              let comparedDivisor = getDivisor(rows, 'date', 'price(USD)');
              prevDate = startDate;
              let newData =  rows.map((row, i) => transformRow(row, i, comparedDivisor, 'date', 'price(USD)')).filter(a => a);
              draw(
                {datasets: [{label: comparedTo.toUpperCase(),data: newData, backgroundColor: 'rgba(0,0,0, .3)'},
                {label: 'C50 Index', data: aggregatedRows, backgroundColor: 'rgba(230,250,92, .8)'}]}
              )
            })
          });
        }


        var tid = setInterval(function() {
            if (document.readyState !== 'complete') return;
            clearInterval(tid);
            let drawScreen = bootstrap();

            drawChart('btc');

            get("https://min-api.cryptocompare.com/data/top/totalvol?limit=52&tsym=USD", drawScreen);
            setInterval(function() {
                get("https://min-api.cryptocompare.com/data/top/totalvol?limit=52&tsym=USD", drawScreen)
            }, 30000);
        }, 100);
    </script>

    <div class='container'>
        <div class='w-100 tc'>
            <div class="w-100 dib tc">
                <img class='tc' width='50px' src='https://camo.githubusercontent.com/fddfe95308fb6a93060ac1526883c8fedde4b450/687474703a2f2f7777772e633530696e6465782e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031382f30352f6335302d66696e616c6c6f676f3262312d312d65313532363232323731313737392d323036783330302e706e67' />
            </div>
            <h2>C50 Tracker</h2>
            <p class='lead'>50 Cryptos in 1</p>
        </div>
        <canvas id="chart" style="width: 100%; height: 250px"></div>
      <div id='coinsTable'></div>
    </div>
</body>

</html>
