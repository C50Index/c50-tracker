<!DOCTYPE html>
<html>

<head>
    <title>C50 Index</title>
    <style>
        .tr {text-align: right;}
        .tl {text-align: left;}
        .tc {text-align: center;}
        .dib {display: inline-block;}
        .w-100 {width: 100%;}
        .w-40 {width: 40%;}
        .w-30 {width: 30%;}
        .hover-bg-light-blue:hover {
          background-color: #b2b2b2;
        }
    </style>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src='./markact.js'></script>
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
</head>
<body>
    <script>
        // Parse CSV in ruby
        let CoinsTable = function(data) {
            let Coins = coins => coins.map((coin,i) => {
                if(!coin) return;
                if(!coin.name) return;
                let name = coin.name
                let symbol = coin.symbol;
                let slug = coin.slug;
                let marketcap = Number(coin.marketcap).toLocaleString();
                let closePrice = Number(coin.close).toLocaleString();


                return (h('tr', {onclick: () => drawChart(symbol), class: 'hover-bg-light-blue'},
                    h('td', {class: 'tc', scope: 'col'}, "" + (i + 1)),
                    h('td', {class: 'tl', scope: 'col'},
                    h('td', {class: 'dib', scope: 'col'},
                        h('img', {
                            class: 'img-responsive',
                            src: `https://cdn.answrly.com/c50/coin-images/${slug}.png`,
                            width: '25px',
                            height: '25px'
                        }),
                        name)
                        ),
                    h('td', {class: 'tr', scope: 'col'}, '$' + marketcap),
                    h('td', {class: 'tr', scope: 'col'}, '$' + closePrice),
                ));
            }).filter(x => x);

            return (
                h('table', {class: 'table table-hover'},
                    h('th', {class: 'tc', scope: 'col'}, '#'),
                    h('th', {class: 'tl', scope: 'col'}, 'Name'),
                    h('th', {class: 'tr', scope: 'col'}, 'Market Cap'),
                    h('th', {class: 'tr', scope: 'col'}, 'Last Close'),
                    Coins(data),
                    ));
        }

        function bootstrap() {
            return (data) => {
                let children = (
                    render(h('div', {class: 'container tc'},
                        CoinsTable(data)))
                );
                let app = document.getElementById('coinsTable');
                if(app.firstChild) app.removeChild(app.firstChild);
                app.appendChild(children);
            }
        }

        function drawChart(symbol) {
          let c50beginningPrice = null;
          let comparedBeginningPrice = null;

          let startDate = moment().year(2017).startOf('year');

          function draw(data) {
            var scatterChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {scales: {
                  xAxes: [{type: 'time',time: {unit: 'month'}}],
                  yAxes: [{
                    scaleLabel: {
                      display: true,
                      labelString: 'Normalized C50 Index'
                    }
                  }]
                },
                tooltips: {
                    callbacks: {
                        title: function(item, data) {
                          var date = item.xLabel;
                          return new moment(date);
                        },
                        label: function(item, data) {
                        var datasetLabel=data.datasets[item.datasetIndex].label||'';
                        var date = item.xLabel;
                        var value = item.yLabel;
                        if(datasetLabel === symbol) {
                          return  datasetLabel + ': $'+ (value * comparedBeginningPrice).toLocaleString();
                        } else {
                          return datasetLabel + ': ' + (value * c50beginningPrice).toLocaleString();
                          }
                        }
                    }
                }
              }
            });
          }

          var ctx = document.getElementById('chart').getContext('2d');
          readCSV('all-coins/c50-index.csv', {headers: true}).then((rows) => {
            // Date: "2016-12-30", C50Index: "101.21617490463628", market_weighted_divisor: "17019127036.0"
            return rows;
          }).then((c50IndexData) => {
            readCSV(`all-coins/${symbol}.csv`, {headers: true}).then((rows) => {

              // calculate c50 index and normalize
              let c50Index = c50IndexData.map(o => {
                let time = new moment(o['Date']);
                  if(!c50beginningPrice) c50beginningPrice = Number(o['C50Index']);
                  return {x: time, y: Number(o['C50Index']) / c50beginningPrice}
              })

              let comparedData = rows.map(o => {
                let time =  new moment(o['time_unix'], "X");
                if(time >= startDate) {
                  if(!comparedBeginningPrice) comparedBeginningPrice = Number(o['close']);
                  return {x: time, y: Number(o['close']) / comparedBeginningPrice}
                } else {
                  return false;
                }
              }).filter(x => x);

                //view-source:http://www.chartjs.org/samples/latest/scales/time/financial.html
                let dataStyles = {pointRadius: 0, fill: true, type: "line", lineTension: 0, borderWidth: 2};

                draw(
                  {datasets: [
                  {label: symbol, data: comparedData, backgroundColor: 'rgba(0,0,0, .3)', ...dataStyles},
                  {label: 'C50 Index', data: c50Index, backgroundColor: 'rgba(230,250,92, .8)', ...dataStyles}
                ]}
                )
              })
          });
        }


        var tid = setInterval(function() {
            if (document.readyState !== 'complete') return;
            clearInterval(tid);
            let drawScreen = bootstrap();

            drawChart('BTC');

            readCSV('all-coins/c50-tracker-summary.csv', {headers: true}).then(drawScreen);
          }, 100);
    </script>

    <div class='container'>
        <div class='w-100 tc'>
            <div class="w-100 dib tc">
                <img class='tc' width='50px' src='https://camo.githubusercontent.com/fddfe95308fb6a93060ac1526883c8fedde4b450/687474703a2f2f7777772e633530696e6465782e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031382f30352f6335302d66696e616c6c6f676f3262312d312d65313532363232323731313737392d323036783330302e706e67' />
            </div>
            <h2>C50 Tracker</h2>
            <p class='lead'>50 Cryptos in 1</p>
            <a href='all-coins/c50-index.csv' download='c50-index.csv' style='color: #111111'; text-align: right;>(Download CSV)</a>
        </div>
        <canvas id="chart" style="width: 100%; height: 250px"></div>
      <div id='coinsTable'></div>
    </div>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-98318782-11"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-98318782-11');
</script>

</body>

</html>
